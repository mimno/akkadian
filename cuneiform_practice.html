<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akkadian Cuneiform Practice</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Cuneiform&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .mode-tab {
            padding: 10px 20px;
            border: 2px solid #e0e7ff;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-tab:hover {
            background: #f0f4ff;
        }

        .mode-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-label {
            color: #666;
            font-size: 0.9em;
        }

        .filter-select {
            padding: 8px 16px;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .prompt {
            text-align: center;
            margin-bottom: 20px;
        }

        .transcription {
            font-size: 2.5em;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 5px;
        }

        .cuneiform-display {
            font-family: 'Noto Sans Cuneiform', serif;
            font-size: 6em;
            color: #333;
            margin: 20px 0;
            line-height: 1;
        }

        .sign-info {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 5px;
        }

        .instruction {
            color: #666;
            font-size: 0.95em;
        }

        .canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .canvas-wrapper {
            max-width: 500px;
            width: 100%;
        }

        .canvas-label {
            text-align: center;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        canvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            width: 100%;
            height: auto;
            background: #fafafa;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .primary-btn {
            background: #667eea;
            color: white;
        }

        .primary-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .secondary-btn {
            background: #e0e7ff;
            color: #667eea;
        }

        .secondary-btn:hover {
            background: #c7d2fe;
        }

        .rating-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .rating-section.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .rating-prompt {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
        }

        .rating-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .rating-btn {
            padding: 12px 20px;
            min-width: 120px;
            border-radius: 10px;
            font-size: 0.95em;
        }

        .rating-btn.rating-1 { background: #e74c3c; color: white; }
        .rating-btn.rating-1:hover { background: #c0392b; }
        .rating-btn.rating-2 { background: #f39c12; color: white; }
        .rating-btn.rating-2:hover { background: #d68910; }
        .rating-btn.rating-3 { background: #3498db; color: white; }
        .rating-btn.rating-3:hover { background: #2980b9; }
        .rating-btn.rating-4 { background: #27ae60; color: white; }
        .rating-btn.rating-4:hover { background: #229954; }

        .keyboard-hint {
            text-align: center;
            color: #999;
            font-size: 0.8em;
            margin-top: 15px;
        }

        .keyboard-hint kbd {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 2px;
        }

        .sign-progress {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            vertical-align: middle;
        }

        .progress-new { background: #e0e7ff; color: #667eea; }
        .progress-learning { background: #ffeaa7; color: #d68910; }
        .progress-known { background: #d5f4e6; color: #27ae60; }

        /* Recognition mode styles */
        .recognition-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .answer-input {
            padding: 15px 25px;
            font-size: 1.5em;
            border: 3px solid #e0e7ff;
            border-radius: 12px;
            text-align: center;
            width: 200px;
            font-family: 'Times New Roman', serif;
            transition: border-color 0.3s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .answer-input.correct {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .answer-input.incorrect {
            border-color: #e74c3c;
            background: #fde8e8;
        }

        /* Multiple choice styles */
        .choice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 400px;
            margin: 20px auto;
        }

        .choice-btn {
            padding: 20px;
            font-size: 1.3em;
            border: 3px solid #e0e7ff;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Times New Roman', serif;
        }

        .choice-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .choice-btn.correct {
            border-color: #27ae60;
            background: #d5f4e6;
            color: #155724;
        }

        .choice-btn.incorrect {
            border-color: #e74c3c;
            background: #fde8e8;
            color: #721c24;
        }

        .choice-btn.disabled {
            pointer-events: none;
        }

        .feedback-message {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .feedback-message.correct {
            background: #d5f4e6;
            color: #155724;
        }

        .feedback-message.incorrect {
            background: #fde8e8;
            color: #721c24;
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .canvas-wrapper { max-width: 100%; }
            .rating-btn { min-width: 80px; padding: 10px 15px; font-size: 0.85em; }
            .stats-bar { gap: 10px; }
            .stat-item { padding: 8px 12px; }
            .cuneiform-display { font-size: 4em; }
            .choice-grid { grid-template-columns: 1fr; max-width: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="dashboard.html" style="text-decoration: none; color: #667eea; font-size: 0.9em;">‚Üê Dashboard</a>
        <h1>íÄ≠ Akkadian Cuneiform Practice</h1>
        <div class="subtitle">Learn to read and write cuneiform signs</div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="signsPracticed">0</div>
                <div class="stat-label">Practiced Today</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="signsLearned">0</div>
                <div class="stat-label">Signs Learned</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">-</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>

        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="write">Write</button>
            <button class="mode-tab" data-mode="recognize">Recognize</button>
            <button class="mode-tab" data-mode="choice">Multiple Choice</button>
        </div>

        <div class="filter-bar">
            <span class="filter-label">Category:</span>
            <select class="filter-select" id="categoryFilter">
                <option value="all">All Signs (53)</option>
                <option value="vowel">Vowels (4)</option>
                <option value="cv">CV Syllables (33)</option>
                <option value="vc">VC Syllables (16)</option>
            </select>
            <span class="filter-label">Focus:</span>
            <select class="filter-select" id="modeFilter">
                <option value="all">All Signs</option>
                <option value="new">New Signs</option>
                <option value="review">Review Weak</option>
            </select>
        </div>

        <!-- WRITE MODE -->
        <div id="writeMode">
            <div class="prompt">
                <div class="transcription">
                    <span id="transcription">a</span>
                    <span class="sign-progress progress-new" id="signProgress">New</span>
                </div>
                <div class="sign-info" id="signInfo">Vowel sign</div>
                <div class="instruction">Draw the cuneiform sign for this transcription</div>
            </div>

            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <div class="canvas-label">Practice Canvas</div>
                    <canvas id="drawingCanvas" width="500" height="500"></canvas>
                </div>
            </div>

            <div class="controls">
                <button class="secondary-btn" id="undoBtn">Undo (U)</button>
                <button class="secondary-btn" id="clearBtn">Clear (C)</button>
                <button class="secondary-btn" id="gridBtn">
                    <span id="gridText">Show Grid (G)</span>
                </button>
                <button class="primary-btn" id="toggleBtn">
                    <span id="toggleText">Show Reference (R)</span>
                </button>
                <button class="primary-btn" id="nextBtn">Next Sign (Space)</button>
            </div>

            <div class="rating-section" id="ratingSection">
                <div class="rating-prompt">How well did you draw this sign?</div>
                <div class="rating-buttons">
                    <button class="rating-btn rating-1" data-rating="1">1 - Again</button>
                    <button class="rating-btn rating-2" data-rating="2">2 - Hard</button>
                    <button class="rating-btn rating-3" data-rating="3">3 - Good</button>
                    <button class="rating-btn rating-4" data-rating="4">4 - Easy</button>
                </div>
            </div>
        </div>

        <!-- RECOGNIZE MODE -->
        <div id="recognizeMode" class="hidden">
            <div class="prompt">
                <div class="instruction">What is the transcription of this sign?</div>
                <div class="cuneiform-display" id="cuneiformDisplay">íÄÄ</div>
                <div class="sign-info" id="recognizeSignInfo">Vowel sign</div>
            </div>

            <div class="recognition-section">
                <input type="text" class="answer-input" id="answerInput" placeholder="Type answer..." autocomplete="off">
                <div style="margin-top: 15px;">
                    <button class="primary-btn" id="checkAnswerBtn">Check (Enter)</button>
                    <button class="primary-btn" id="recognizeNextBtn" style="display: none;">Next (Space)</button>
                </div>
                <div class="feedback-message hidden" id="recognizeFeedback"></div>
            </div>
        </div>

        <!-- MULTIPLE CHOICE MODE -->
        <div id="choiceMode" class="hidden">
            <div class="prompt">
                <div class="instruction">Select the correct transcription for this sign:</div>
                <div class="cuneiform-display" id="choiceCuneiform">íÄÄ</div>
                <div class="sign-info" id="choiceSignInfo">Vowel sign</div>
            </div>

            <div class="choice-grid" id="choiceGrid">
                <button class="choice-btn" data-index="0">a</button>
                <button class="choice-btn" data-index="1">e</button>
                <button class="choice-btn" data-index="2">i</button>
                <button class="choice-btn" data-index="3">u</button>
            </div>

            <div class="feedback-message hidden" id="choiceFeedback"></div>

            <div class="controls">
                <button class="primary-btn hidden" id="choiceNextBtn">Next Sign (Space)</button>
            </div>
        </div>

        <div class="keyboard-hint" id="keyboardHint">
            Shortcuts: <kbd>Space</kbd> Next ¬∑ <kbd>R</kbd> Reference ¬∑ <kbd>G</kbd> Grid ¬∑ <kbd>C</kbd> Clear ¬∑ <kbd>U</kbd> Undo ¬∑ <kbd>1-4</kbd> Rate
        </div>
    </div>

    <script>
        // Common Akkadian cuneiform signs with categories
        const signs = [
            // Vowels
            { trans: 'a', unicode: 'íÄÄ', category: 'vowel' },
            { trans: 'e', unicode: 'íÇä', category: 'vowel' },
            { trans: 'i', unicode: 'íÑø', category: 'vowel' },
            { trans: 'u', unicode: 'íåã', category: 'vowel' },

            // CV syllables (consonant + vowel)
            { trans: 'ba', unicode: 'íÅÄ', category: 'cv' },
            { trans: 'bi', unicode: 'íÅâ', category: 'cv' },
            { trans: 'da', unicode: 'íÅï', category: 'cv' },
            { trans: 'di', unicode: 'íÅ≤', category: 'cv' },
            { trans: 'du', unicode: 'íÅ∫', category: 'cv' },
            { trans: 'ga', unicode: 'íÇµ', category: 'cv' },
            { trans: 'gi', unicode: 'íÑÄ', category: 'cv' },
            { trans: 'gu', unicode: 'íÑñ', category: 'cv' },
            { trans: 'ka', unicode: 'íÖó', category: 'cv' },
            { trans: 'ki', unicode: 'íÜ†', category: 'cv' },
            { trans: 'ku', unicode: 'íÜ™', category: 'cv' },
            { trans: 'la', unicode: 'íÜ∑', category: 'cv' },
            { trans: 'li', unicode: 'íá∑', category: 'cv' },
            { trans: 'lu', unicode: 'íáª', category: 'cv' },
            { trans: 'ma', unicode: 'íà†', category: 'cv' },
            { trans: 'mi', unicode: 'íà™', category: 'cv' },
            { trans: 'mu', unicode: 'íà¨', category: 'cv' },
            { trans: 'na', unicode: 'íàæ', category: 'cv' },
            { trans: 'ni', unicode: 'íâå', category: 'cv' },
            { trans: 'nu', unicode: 'íâ°', category: 'cv' },
            { trans: 'pa', unicode: 'íâ∫', category: 'cv' },
            { trans: 'ra', unicode: 'íäè', category: 'cv' },
            { trans: 'ri', unicode: 'íäë', category: 'cv' },
            { trans: 'ru', unicode: 'íäí', category: 'cv' },
            { trans: 'sa', unicode: 'íäì', category: 'cv' },
            { trans: 'si', unicode: 'íãõ', category: 'cv' },
            { trans: '≈°u', unicode: 'íãó', category: 'cv' },
            { trans: 'ta', unicode: 'íã´', category: 'cv' },
            { trans: 'ti', unicode: 'íãæ', category: 'cv' },
            { trans: 'tu', unicode: 'íåÖ', category: 'cv' },
            { trans: 'za', unicode: 'íçù', category: 'cv' },
            { trans: 'zi', unicode: 'íç£', category: 'cv' },

            // VC syllables (vowel + consonant)
            { trans: 'ab', unicode: 'íÄä', category: 'vc' },
            { trans: 'ad', unicode: 'íÄú', category: 'vc' },
            { trans: 'ak', unicode: 'íÄù', category: 'vc' },
            { trans: 'al', unicode: 'íÄ†', category: 'vc' },
            { trans: 'am', unicode: 'íÑ†', category: 'vc' },
            { trans: 'an', unicode: 'íÄ≠', category: 'vc' },
            { trans: 'ar', unicode: 'íÖà', category: 'vc' },
            { trans: 'a≈°', unicode: 'íÄ∏', category: 'vc' },
            { trans: 'ib', unicode: 'íÖÅ', category: 'vc' },
            { trans: 'il', unicode: 'íÖã', category: 'vc' },
            { trans: 'im', unicode: 'íÖé', category: 'vc' },
            { trans: 'in', unicode: 'íÖî', category: 'vc' },
            { trans: 'i≈°', unicode: 'íÖñ', category: 'vc' },
            { trans: 'um', unicode: 'íåù', category: 'vc' },
            { trans: 'ur', unicode: 'íå®', category: 'vc' },
            { trans: 'u≈°', unicode: 'íçë', category: 'vc' }
        ];

        const categoryLabels = {
            'vowel': 'Vowel sign',
            'cv': 'CV syllable (consonant-vowel)',
            'vc': 'VC syllable (vowel-consonant)'
        };

        // State
        let currentMode = 'write';
        let progress = loadProgress();
        let sessionStats = { practiced: 0, correct: 0, total: 0 };
        let currentSign = signs[0];
        let isDrawing = false;
        let showingReference = false;
        let showingGrid = false;
        let hasDrawn = false;
        let userStrokes = [];
        let drawStartPoint = null;
        let choiceAnswered = false;
        let correctChoiceIndex = 0;

        // Canvas setup
        const drawingCanvas = document.getElementById('drawingCanvas');
        const drawingCtx = drawingCanvas.getContext('2d');
        const refCanvas = document.createElement('canvas');
        refCanvas.width = drawingCanvas.width;
        refCanvas.height = drawingCanvas.height;
        const refCtx = refCanvas.getContext('2d');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = drawingCanvas.width;
        tempCanvas.height = drawingCanvas.height;
        const tempCtx = tempCanvas.getContext('2d');

        // Progress functions
        function loadProgress() {
            const saved = localStorage.getItem('cuneiformProgress');
            return saved ? JSON.parse(saved) : {};
        }

        function saveProgress() {
            localStorage.setItem('cuneiformProgress', JSON.stringify(progress));
        }

        function getSignLevel(trans) {
            const p = progress[trans];
            if (!p || p.count === 0) return 'new';
            const avgRating = p.totalRating / p.count;
            if (avgRating >= 3.5 && p.count >= 3) return 'known';
            return 'learning';
        }

        function recordProgress(trans, rating) {
            if (!progress[trans]) {
                progress[trans] = { count: 0, totalRating: 0, lastPracticed: null };
            }
            progress[trans].count++;
            progress[trans].totalRating += rating;
            progress[trans].lastPracticed = Date.now();
            saveProgress();
            sessionStats.practiced++;
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('signsPracticed').textContent = sessionStats.practiced;

            let learned = 0;
            for (const trans in progress) {
                if (getSignLevel(trans) === 'known') learned++;
            }
            document.getElementById('signsLearned').textContent = learned;

            if (sessionStats.total > 0) {
                const acc = Math.round((sessionStats.correct / sessionStats.total) * 100);
                document.getElementById('accuracy').textContent = acc + '%';
            } else {
                document.getElementById('accuracy').textContent = '-';
            }
        }

        function getFilteredSigns() {
            const category = document.getElementById('categoryFilter').value;
            const mode = document.getElementById('modeFilter').value;
            let filtered = signs;

            if (category !== 'all') {
                filtered = filtered.filter(s => s.category === category);
            }

            if (mode === 'new') {
                filtered = filtered.filter(s => getSignLevel(s.trans) === 'new');
            } else if (mode === 'review') {
                filtered = filtered.filter(s => {
                    const level = getSignLevel(s.trans);
                    return level === 'learning' || level === 'new';
                });
            }

            return filtered.length > 0 ? filtered : signs;
        }

        function selectNextSign() {
            const filtered = getFilteredSigns();
            let weights = filtered.map(s => {
                const level = getSignLevel(s.trans);
                if (level === 'new') return 3;
                if (level === 'learning') return 2;
                return 1;
            });

            const totalWeight = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;

            for (let i = 0; i < filtered.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    currentSign = filtered[i];
                    break;
                }
            }
        }

        function updateSignProgressBadge() {
            const badge = document.getElementById('signProgress');
            const level = getSignLevel(currentSign.trans);
            badge.className = 'sign-progress';
            if (level === 'new') {
                badge.classList.add('progress-new');
                badge.textContent = 'New';
            } else if (level === 'learning') {
                badge.classList.add('progress-learning');
                badge.textContent = 'Learning';
            } else {
                badge.classList.add('progress-known');
                badge.textContent = 'Known';
            }
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });

            document.getElementById('writeMode').classList.toggle('hidden', mode !== 'write');
            document.getElementById('recognizeMode').classList.toggle('hidden', mode !== 'recognize');
            document.getElementById('choiceMode').classList.toggle('hidden', mode !== 'choice');

            // Update keyboard hints
            const hint = document.getElementById('keyboardHint');
            if (mode === 'write') {
                hint.innerHTML = 'Shortcuts: <kbd>Space</kbd> Next ¬∑ <kbd>R</kbd> Reference ¬∑ <kbd>G</kbd> Grid ¬∑ <kbd>C</kbd> Clear ¬∑ <kbd>U</kbd> Undo ¬∑ <kbd>1-4</kbd> Rate';
            } else if (mode === 'recognize') {
                hint.innerHTML = 'Shortcuts: <kbd>Enter</kbd> Check ¬∑ <kbd>Space</kbd> Next';
            } else {
                hint.innerHTML = 'Shortcuts: <kbd>1-4</kbd> Select ¬∑ <kbd>Space</kbd> Next';
            }

            nextSign();
        }

        // WRITE MODE functions
        function generateReference() {
            refCtx.clearRect(0, 0, refCanvas.width, refCanvas.height);
            refCtx.fillStyle = '#333';
            refCtx.font = '280px "Noto Sans Cuneiform"';
            refCtx.textAlign = 'center';
            refCtx.textBaseline = 'middle';
            refCtx.fillText(currentSign.unicode, refCanvas.width / 2, refCanvas.height / 2);
        }

        function redrawCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

            // Draw grid if enabled
            if (showingGrid) {
                drawGrid();
            }

            // Draw reference if enabled
            if (showingReference) {
                drawingCtx.globalAlpha = 0.25;
                drawingCtx.drawImage(refCanvas, 0, 0);
                drawingCtx.globalAlpha = 1.0;
            }

            // Draw user strokes on top
            userStrokes.forEach(stroke => {
                drawWedge(drawingCtx, stroke.x1, stroke.y1, stroke.x2, stroke.y2, '#333', 0.7);
            });
        }

        function drawGrid() {
            const w = drawingCanvas.width;
            const h = drawingCanvas.height;
            const gridSize = 50; // Grid cell size in pixels

            drawingCtx.save();
            drawingCtx.strokeStyle = '#ddd';
            drawingCtx.lineWidth = 1;

            // Draw vertical lines
            for (let x = gridSize; x < w; x += gridSize) {
                drawingCtx.beginPath();
                drawingCtx.moveTo(x, 0);
                drawingCtx.lineTo(x, h);
                drawingCtx.stroke();
            }

            // Draw horizontal lines
            for (let y = gridSize; y < h; y += gridSize) {
                drawingCtx.beginPath();
                drawingCtx.moveTo(0, y);
                drawingCtx.lineTo(w, y);
                drawingCtx.stroke();
            }

            // Draw center lines (thicker)
            drawingCtx.strokeStyle = '#bbb';
            drawingCtx.lineWidth = 2;

            // Vertical center
            drawingCtx.beginPath();
            drawingCtx.moveTo(w / 2, 0);
            drawingCtx.lineTo(w / 2, h);
            drawingCtx.stroke();

            // Horizontal center
            drawingCtx.beginPath();
            drawingCtx.moveTo(0, h / 2);
            drawingCtx.lineTo(w, h / 2);
            drawingCtx.stroke();

            // Draw corner markers for sign boundary (inner square)
            const margin = 75;
            drawingCtx.strokeStyle = '#aaa';
            drawingCtx.lineWidth = 2;
            drawingCtx.setLineDash([5, 5]);

            drawingCtx.beginPath();
            drawingCtx.rect(margin, margin, w - margin * 2, h - margin * 2);
            drawingCtx.stroke();

            drawingCtx.setLineDash([]);
            drawingCtx.restore();
        }

        function toggleGrid() {
            showingGrid = !showingGrid;
            document.getElementById('gridText').textContent =
                showingGrid ? 'Hide Grid (G)' : 'Show Grid (G)';
            redrawCanvas();
        }

        function drawWedge(ctx, x1, y1, x2, y2, color = '#333', alpha = 1.0) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 3) return;

            const perpX = -dy / dist;
            const perpY = dx / dist;
            const startWidth = 20;

            ctx.globalAlpha = alpha;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x1 + perpX * startWidth, y1 + perpY * startWidth);
            ctx.lineTo(x1 - perpX * startWidth, y1 - perpY * startWidth);
            ctx.lineTo(x2, y2);
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }

        function getCanvasCoordinates(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            drawStartPoint = getCanvasCoordinates(e, drawingCanvas);
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            redrawCanvas();
            tempCtx.drawImage(drawingCanvas, 0, 0);
        }

        function draw(e) {
            if (!isDrawing || !drawStartPoint) return;
            const currentPoint = getCanvasCoordinates(e, drawingCanvas);
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawingCtx.drawImage(tempCanvas, 0, 0);
            drawWedge(drawingCtx, drawStartPoint.x, drawStartPoint.y, currentPoint.x, currentPoint.y, 'rgba(102, 126, 234, 0.8)', 0.5);
        }

        function stopDrawing(e) {
            if (!isDrawing || !drawStartPoint) return;
            const endPoint = e.type.includes('touch') ?
                getCanvasCoordinates(e.changedTouches[0], drawingCanvas) :
                getCanvasCoordinates(e, drawingCanvas);

            userStrokes.push({ x1: drawStartPoint.x, y1: drawStartPoint.y, x2: endPoint.x, y2: endPoint.y });
            redrawCanvas();
            isDrawing = false;
            drawStartPoint = null;

            if (!hasDrawn && userStrokes.length > 0) {
                hasDrawn = true;
                document.getElementById('ratingSection').classList.add('visible');
            }
        }

        function cancelDrawing() {
            if (isDrawing) redrawCanvas();
            isDrawing = false;
            drawStartPoint = null;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            drawingCanvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            userStrokes = [];
            redrawCanvas();
        }

        function undoStroke() {
            if (userStrokes.length > 0) {
                userStrokes.pop();
                redrawCanvas();
            }
        }

        function toggleReference() {
            showingReference = !showingReference;
            document.getElementById('toggleText').textContent =
                showingReference ? 'Hide Reference (R)' : 'Show Reference (R)';
            redrawCanvas();
        }

        function rateSign(rating) {
            recordProgress(currentSign.trans, rating);
            nextSign();
        }

        // RECOGNIZE MODE functions
        function setupRecognizeMode() {
            document.getElementById('cuneiformDisplay').textContent = currentSign.unicode;
            document.getElementById('recognizeSignInfo').textContent = categoryLabels[currentSign.category];
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').className = 'answer-input';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('checkAnswerBtn').style.display = 'inline-block';
            document.getElementById('recognizeNextBtn').style.display = 'none';
            document.getElementById('recognizeFeedback').classList.add('hidden');
            document.getElementById('answerInput').focus();
        }

        function checkRecognizeAnswer() {
            const input = document.getElementById('answerInput');
            const answer = input.value.trim().toLowerCase();
            const correct = currentSign.trans.toLowerCase();
            const feedback = document.getElementById('recognizeFeedback');

            sessionStats.total++;

            if (answer === correct) {
                sessionStats.correct++;
                input.classList.add('correct');
                feedback.textContent = 'Correct!';
                feedback.className = 'feedback-message correct';
                recordProgress(currentSign.trans, 4);
            } else {
                input.classList.add('incorrect');
                feedback.textContent = `Incorrect. The answer is "${currentSign.trans}"`;
                feedback.className = 'feedback-message incorrect';
                recordProgress(currentSign.trans, 1);
            }

            feedback.classList.remove('hidden');
            input.disabled = true;
            document.getElementById('checkAnswerBtn').style.display = 'none';
            document.getElementById('recognizeNextBtn').style.display = 'inline-block';
            document.getElementById('recognizeNextBtn').focus();
        }

        // MULTIPLE CHOICE MODE functions
        function setupChoiceMode() {
            document.getElementById('choiceCuneiform').textContent = currentSign.unicode;
            document.getElementById('choiceSignInfo').textContent = categoryLabels[currentSign.category];

            // Generate 4 choices including the correct answer
            const filtered = getFilteredSigns();
            let choices = [currentSign];
            const otherSigns = filtered.filter(s => s.trans !== currentSign.trans);

            // Shuffle and pick 3 wrong answers
            const shuffled = otherSigns.sort(() => Math.random() - 0.5);
            choices = choices.concat(shuffled.slice(0, 3));

            // Shuffle all choices
            choices = choices.sort(() => Math.random() - 0.5);
            correctChoiceIndex = choices.findIndex(s => s.trans === currentSign.trans);

            // Update buttons
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach((btn, i) => {
                btn.textContent = choices[i].trans;
                btn.className = 'choice-btn';
                btn.dataset.correct = (i === correctChoiceIndex) ? 'true' : 'false';
            });

            choiceAnswered = false;
            document.getElementById('choiceFeedback').classList.add('hidden');
            document.getElementById('choiceNextBtn').classList.add('hidden');
        }

        function handleChoiceClick(index) {
            if (choiceAnswered) return;
            choiceAnswered = true;

            const buttons = document.querySelectorAll('.choice-btn');
            const feedback = document.getElementById('choiceFeedback');

            sessionStats.total++;

            buttons.forEach((btn, i) => {
                btn.classList.add('disabled');
                if (btn.dataset.correct === 'true') {
                    btn.classList.add('correct');
                } else if (i === index) {
                    btn.classList.add('incorrect');
                }
            });

            if (index === correctChoiceIndex) {
                sessionStats.correct++;
                feedback.textContent = 'Correct!';
                feedback.className = 'feedback-message correct';
                recordProgress(currentSign.trans, 4);
            } else {
                feedback.textContent = `Incorrect. The answer is "${currentSign.trans}"`;
                feedback.className = 'feedback-message incorrect';
                recordProgress(currentSign.trans, 1);
            }

            feedback.classList.remove('hidden');
            document.getElementById('choiceNextBtn').classList.remove('hidden');
        }

        // Next sign for all modes
        function nextSign() {
            selectNextSign();

            if (currentMode === 'write') {
                document.getElementById('transcription').childNodes[0].textContent = currentSign.trans;
                document.getElementById('signInfo').textContent = categoryLabels[currentSign.category];
                updateSignProgressBadge();
                userStrokes = [];
                hasDrawn = false;
                showingReference = false;
                document.getElementById('toggleText').textContent = 'Show Reference (R)';
                document.getElementById('ratingSection').classList.remove('visible');
                generateReference();
                redrawCanvas();
            } else if (currentMode === 'recognize') {
                setupRecognizeMode();
            } else if (currentMode === 'choice') {
                setupChoiceMode();
            }
        }

        function updateCategoryCounts() {
            const counts = {
                all: signs.length,
                vowel: signs.filter(s => s.category === 'vowel').length,
                cv: signs.filter(s => s.category === 'cv').length,
                vc: signs.filter(s => s.category === 'vc').length
            };

            const select = document.getElementById('categoryFilter');
            select.options[0].textContent = `All Signs (${counts.all})`;
            select.options[1].textContent = `Vowels (${counts.vowel})`;
            select.options[2].textContent = `CV Syllables (${counts.cv})`;
            select.options[3].textContent = `VC Syllables (${counts.vc})`;
        }

        // Event listeners
        drawingCanvas.addEventListener('mousedown', startDrawing);
        drawingCanvas.addEventListener('mousemove', draw);
        drawingCanvas.addEventListener('mouseup', stopDrawing);
        drawingCanvas.addEventListener('mouseout', cancelDrawing);
        drawingCanvas.addEventListener('touchstart', handleTouch);
        drawingCanvas.addEventListener('touchmove', handleTouch);
        drawingCanvas.addEventListener('touchend', stopDrawing);

        document.getElementById('clearBtn').addEventListener('click', clearCanvas);
        document.getElementById('undoBtn').addEventListener('click', undoStroke);
        document.getElementById('gridBtn').addEventListener('click', toggleGrid);
        document.getElementById('toggleBtn').addEventListener('click', toggleReference);
        document.getElementById('nextBtn').addEventListener('click', nextSign);

        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.addEventListener('click', () => rateSign(parseInt(btn.dataset.rating)));
        });

        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', () => switchMode(tab.dataset.mode));
        });

        document.getElementById('categoryFilter').addEventListener('change', () => {
            updateCategoryCounts();
            nextSign();
        });
        document.getElementById('modeFilter').addEventListener('change', nextSign);

        // Recognize mode events
        document.getElementById('checkAnswerBtn').addEventListener('click', checkRecognizeAnswer);
        document.getElementById('recognizeNextBtn').addEventListener('click', nextSign);
        document.getElementById('answerInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('answerInput').disabled) {
                    checkRecognizeAnswer();
                } else {
                    nextSign();
                }
            }
        });

        // Choice mode events
        document.querySelectorAll('.choice-btn').forEach((btn, i) => {
            btn.addEventListener('click', () => handleChoiceClick(i));
        });
        document.getElementById('choiceNextBtn').addEventListener('click', nextSign);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            if (currentMode === 'write') {
                switch(e.key.toLowerCase()) {
                    case ' ':
                        e.preventDefault();
                        nextSign();
                        break;
                    case 'r':
                        toggleReference();
                        break;
                    case 'g':
                        toggleGrid();
                        break;
                    case 'c':
                        clearCanvas();
                        break;
                    case 'u':
                        undoStroke();
                        break;
                    case '1': case '2': case '3': case '4':
                        if (hasDrawn) rateSign(parseInt(e.key));
                        break;
                }
            } else if (currentMode === 'recognize') {
                if (e.key === ' ') {
                    e.preventDefault();
                    if (document.getElementById('answerInput').disabled) {
                        nextSign();
                    }
                }
            } else if (currentMode === 'choice') {
                if (e.key === ' ') {
                    e.preventDefault();
                    if (choiceAnswered) nextSign();
                } else if (['1','2','3','4'].includes(e.key) && !choiceAnswered) {
                    handleChoiceClick(parseInt(e.key) - 1);
                }
            }
        });

        // Initialize
        updateCategoryCounts();
        updateStatsDisplay();
        updateSignProgressBadge();
        generateReference();
        redrawCanvas();
    </script>
</body>
</html>
